import React, { useEffect, useMemo, useRef, useState } from "react";

// === Utilidades simples ===
const formatNumber = (n: number, digits = 2) =>
  isFinite(n) ? n.toLocaleString("es-AR", { maximumFractionDigits: digits }) : "-";

const download = (filename: string, data: object) => {
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  a.click();
  URL.revokeObjectURL(url);
};

// === Tipos ===
interface StopEvent {
  id: string;
  fecha: string; // ISO
  equipo: string;
  motivo: string;
  downtimeMin: number; // minutos
}

interface WorkOrder {
  id: string;
  fecha: string; // ISO
  equipo: string;
  tipo: "Preventivo" | "Correctivo" | "Predictivo" | "Mejora";
  estado: "Planificada" | "En curso" | "Completada" | "Cancelada";
  hh?: number; // horas hombre estimadas o reales
}

interface AppState {
  periodoDesde: string; // ISO date
  periodoHasta: string; // ISO date
  horasPlanificadas: number; // horas calendario/operación del periodo
  ventasARS: number;
  costoMantenimientoARS: number;
  capacidadHHsemana: number; // para backlog simple
  paradas: StopEvent[];
  ots: WorkOrder[];
}

const STORAGE_KEY = "kpi-mantenimiento-mvp-v1";

// === Componente principal ===
export default function App() {
  const [state, setState] = useState<AppState>(() => {
    const saved = localStorage.getItem(STORAGE_KEY);
    if (saved) return JSON.parse(saved);
    const hoy = new Date();
    const primerDiaMes = new Date(hoy.getFullYear(), hoy.getMonth(), 1)
      .toISOString()
      .slice(0, 10);
    const ultimoDiaMes = new Date(hoy.getFullYear(), hoy.getMonth() + 1, 0)
      .toISOString()
      .slice(0, 10);
    return {
      periodoDesde: primerDiaMes,
      periodoHasta: ultimoDiaMes,
      horasPlanificadas: 720, // default 30 días * 24h (ajustable)
      ventasARS: 0,
      costoMantenimientoARS: 0,
      capacidadHHsemana: 160, // 4 técnicos * 40h/semana (ejemplo)
      paradas: [],
      ots: [],
    } as AppState;
  });

  // Persistencia
  useEffect(() => {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  }, [state]);

  // === Derivados y KPIs ===
  const downtimeTotalMin = useMemo(
    () => state.paradas.reduce((acc, p) => acc + (Number(p.downtimeMin) || 0), 0),
    [state.paradas]
  );
  const fallas = state.paradas.length;
  const downtimeHoras = downtimeTotalMin / 60;
  const uptimeHoras = Math.max(0, (Number(state.horasPlanificadas) || 0) - downtimeHoras);

  const MTTR_h = useMemo(() => (fallas > 0 ? downtimeHoras / fallas : 0), [downtimeHoras, fallas]);
  const MTBF_h = useMemo(() => (fallas > 0 ? uptimeHoras / fallas : 0), [uptimeHoras, fallas]);
  const disponibilidad = useMemo(() => {
    const hp = Number(state.horasPlanificadas) || 0;
    return hp > 0 ? uptimeHoras / hp : 0;
  }, [uptimeHoras, state.horasPlanificadas]);

  const otsPlanificadas = state.ots.filter((o) => o.estado === "Planificada").length;
  const otsCompletadas = state.ots.filter((o) => o.estado === "Completada").length;
  const cumplimientoPlan = (otsCompletadas / Math.max(1, otsCompletadas + otsPlanificadas)) * 100; // simple

  const totalHHpendientes = state.ots
    .filter((o) => o.estado !== "Completada" && o.estado !== "Cancelada")
    .reduce((acc, o) => acc + (o.hh || 0), 0);
  const backlogSemanas = totalHHpendientes / Math.max(1, state.capacidadHHsemana);

  const otsPrev = state.ots.filter((o) => o.tipo === "Preventivo").length;
  const otsCorr = state.ots.filter((o) => o.tipo === "Correctivo").length;
  const otsTot = Math.max(1, state.ots.length);
  const pctPrev = (otsPrev / otsTot) * 100;
  const pctCorr = (otsCorr / otsTot) * 100;

  const ratioCostoVentas = useMemo(() => {
    const v = Number(state.ventasARS) || 0;
    const c = Number(state.costoMantenimientoARS) || 0;
    return v > 0 ? c / v : 0;
  }, [state.ventasARS, state.costoMantenimientoARS]);

  // === Manejo de formularios ===
  const addParada = () => {
    setState((s) => ({
      ...s,
      paradas: [
        ...s.paradas,
        {
          id: crypto.randomUUID(),
          fecha: new Date().toISOString().slice(0, 16),
          equipo: "",
          motivo: "",
          downtimeMin: 0,
        },
      ],
    }));
  };

  const addOT = () => {
    setState((s) => ({
      ...s,
      ots: [
        ...s.ots,
        {
          id: crypto.randomUUID(),
          fecha: new Date().toISOString().slice(0, 10),
          equipo: "",
          tipo: "Preventivo",
          estado: "Planificada",
          hh: 0,
        },
      ],
    }));
  };

  const fileInputRef = useRef<HTMLInputElement | null>(null);

  const onImport = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      try {
        const data = JSON.parse(String(reader.result));
        setState(data);
      } catch (err) {
        alert("Archivo inválido");
      }
    };
    reader.readAsText(file);
    if (fileInputRef.current) fileInputRef.current.value = "";
  };

  const resetData = () => {
    if (!confirm("¿Vaciar todos los datos del dashboard?")) return;
    localStorage.removeItem(STORAGE_KEY);
    location.reload();
  };

  // === UI ===
  return (
    <div className="min-h-screen w-full bg-neutral-100 text-neutral-900 p-4 sm:p-6">
      <div className="max-w-7xl mx-auto">
        <header className="flex items-center justify-between gap-4 mb-6">
          <div>
            <h1 className="text-2xl sm:text-3xl font-semibold">KPIs de Mantenimiento — Tablero (MVP)</h1>
            <p className="text-sm text-neutral-600">MTBF, MTTR, Disponibilidad, % Preventivo/Correctivo, Cumplimiento del plan, Backlog, Ratio Costo/Ventas</p>
          </div>
          <div className="flex flex-wrap gap-2">
            <button
              onClick={() => download("kpis-mantenimiento.json", state)}
              className="px-3 py-2 rounded-2xl bg-white shadow hover:shadow-md border"
            >
              Exportar JSON
            </button>
            <label className="px-3 py-2 rounded-2xl bg-white shadow hover:shadow-md border cursor-pointer">
              Importar JSON
              <input ref={fileInputRef} type="file" accept="application/json" className="hidden" onChange={onImport} />
            </label>
            <button onClick={resetData} className="px-3 py-2 rounded-2xl bg-white shadow hover:shadow-md border">
              Reiniciar
            </button>
          </div>
        </header>

        {/* Configuración del periodo */}
        <section className="grid md:grid-cols-3 gap-4 mb-6">
          <div className="bg-white rounded-2xl shadow p-4 border">
            <h2 className="font-medium mb-3">Periodo</h2>
            <div className="grid grid-cols-2 gap-3">
              <div>
                <label className="text-xs text-neutral-600">Desde</label>
                <input
                  type="date"
                  className="w-full border rounded-xl p-2"
                  value={state.periodoDesde}
                  onChange={(e) => setState({ ...state, periodoDesde: e.target.value })}
                />
              </div>
              <div>
                <label className="text-xs text-neutral-600">Hasta</label>
                <input
                  type="date"
                  className="w-full border rounded-xl p-2"
                  value={state.periodoHasta}
                  onChange={(e) => setState({ ...state, periodoHasta: e.target.value })}
                />
              </div>
              <div className="col-span-2">
                <label className="text-xs text-neutral-600">Horas planificadas en el periodo</label>
                <input
                  type="number"
                  min={0}
                  className="w-full border rounded-xl p-2"
                  value={state.horasPlanificadas}
                  onChange={(e) => setState({ ...state, horasPlanificadas: Number(e.target.value) })}
                />
              </div>
            </div>
          </div>

          <div className="bg-white rounded-2xl shadow p-4 border">
            <h2 className="font-medium mb-3">Economía</h2>
            <div className="grid grid-cols-2 gap-3">
              <div>
                <label className="text-xs text-neutral-600">Ventas ARS</label>
                <input
                  type="number"
                  min={0}
                  className="w-full border rounded-xl p-2"
                  value={state.ventasARS}
                  onChange={(e) => setState({ ...state, ventasARS: Number(e.target.value) })}
                />
              </div>
              <div>
                <label className="text-xs text-neutral-600">Costo mant. ARS</label>
                <input
                  type="number"
                  min={0}
                  className="w-full border rounded-xl p-2"
                  value={state.costoMantenimientoARS}
                  onChange={(e) => setState({ ...state, costoMantenimientoARS: Number(e.target.value) })}
                />
              </div>
              <div className="col-span-2">
                <p className="text-sm text-neutral-600">Ratio Costo/Ventas: <span className="font-semibold">{formatNumber(ratioCostoVentas, 3)}</span></p>
              </div>
            </div>
          </div>

          <div className="bg-white rounded-2xl shadow p-4 border">
            <h2 className="font-medium mb-3">Capacidad & Backlog</h2>
            <div className="grid grid-cols-2 gap-3">
              <div className="col-span-2">
                <label className="text-xs text-neutral-600">Capacidad HH por semana</label>
                <input
                  type="number"
                  min={0}
                  className="w-full border rounded-xl p-2"
                  value={state.capacidadHHsemana}
                  onChange={(e) => setState({ ...state, capacidadHHsemana: Number(e.target.value) })}
                />
              </div>
              <div className="col-span-2 text-sm text-neutral-600">
                Backlog: <span className="font-semibold">{formatNumber(backlogSemanas, 2)} semanas</span>
              </div>
            </div>
          </div>
        </section>

        {/* Tarjetas de KPIs */}
        <section className="grid md:grid-cols-3 xl:grid-cols-6 gap-4 mb-6">
          <KpiCard title="MTBF" value={`${formatNumber(MTBF_h)} h`} hint={`${fallas} fallas`} />
          <KpiCard title="MTTR" value={`${formatNumber(MTTR_h)} h`} hint={`${formatNumber(downtimeHoras)} h paro`} />
          <KpiCard title="Disponibilidad" value={`${formatNumber(disponibilidad * 100)} %`} hint={`${formatNumber(uptimeHoras)} h uptime`} />
          <KpiCard title="Cumplimiento plan" value={`${formatNumber(cumplimientoPlan)} %`} hint={`${otsCompletadas}/${otsCompletadas + otsPlanificadas}`} />
          <KpiCard title="% Preventivo" value={`${formatNumber(pctPrev)} %`} hint={`${otsPrev}/${state.ots.length} OTs`} />
          <KpiCard title="% Correctivo" value={`${formatNumber(pctCorr)} %`} hint={`${otsCorr}/${state.ots.length} OTs`} />
        </section>

        <div className="grid lg:grid-cols-2 gap-6">
          {/* Paradas */}
          <section className="bg-white rounded-2xl shadow p-4 border">
            <div className="flex items-center justify-between mb-3">
              <h2 className="font-medium">Eventos de Parada</h2>
              <button onClick={addParada} className="px-3 py-2 rounded-xl bg-neutral-900 text-white hover:opacity-90">+ Agregar</button>
            </div>
            <div className="overflow-auto">
              <table className="w-full text-sm">
                <thead>
                  <tr className="text-left text-neutral-600">
                    <th className="p-2">Fecha y hora</th>
                    <th className="p-2">Equipo</th>
                    <th className="p-2">Motivo</th>
                    <th className="p-2">Downtime (min)</th>
                    <th className="p-2"></th>
                  </tr>
                </thead>
                <tbody>
                  {state.paradas.length === 0 && (
                    <tr>
                      <td className="p-3 text-neutral-500" colSpan={5}>Sin paradas cargadas.</td>
                    </tr>
                  )}
                  {state.paradas.map((p) => (
                    <tr key={p.id} className="border-t">
                      <td className="p-2">
                        <input
                          type="datetime-local"
                          className="border rounded-lg p-2 w-full"
                          value={p.fecha}
                          onChange={(e) =>
                            setState((s) => ({
                              ...s,
                              paradas: s.paradas.map((x) => (x.id === p.id ? { ...x, fecha: e.target.value } : x)),
                            }))
                          }
                        />
                      </td>
                      <td className="p-2">
                        <input
                          type="text"
                          className="border rounded-lg p-2 w-full"
                          value={p.equipo}
                          onChange={(e) =>
                            setState((s) => ({
                              ...s,
                              paradas: s.paradas.map((x) => (x.id === p.id ? { ...x, equipo: e.target.value } : x)),
                            }))
                          }
                        />
                      </td>
                      <td className="p-2">
                        <input
                          type="text"
                          className="border rounded-lg p-2 w-full"
                          value={p.motivo}
                          onChange={(e) =>
                            setState((s) => ({
                              ...s,
                              paradas: s.paradas.map((x) => (x.id === p.id ? { ...x, motivo: e.target.value } : x)),
                            }))
                          }
                        />
                      </td>
                      <td className="p-2">
                        <input
                          type="number"
                          min={0}
                          className="border rounded-lg p-2 w-32"
                          value={p.downtimeMin}
                          onChange={(e) =>
                            setState((s) => ({
                              ...s,
                              paradas: s.paradas.map((x) =>
                                x.id === p.id ? { ...x, downtimeMin: Number(e.target.value) } : x
                              ),
                            }))
                          }
                        />
                      </td>
                      <td className="p-2 text-right">
                        <button
                          onClick={() =>
                            setState((s) => ({ ...s, paradas: s.paradas.filter((x) => x.id !== p.id) }))
                          }
                          className="px-2 py-1 rounded-lg border hover:bg-neutral-50"
                        >
                          Eliminar
                        </button>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
            <div className="mt-3 text-xs text-neutral-500">
              Downtime total: {formatNumber(downtimeTotalMin)} min — {formatNumber(downtimeHoras)} h.
            </div>
          </section>

          {/* OTs */}
          <section className="bg-white rounded-2xl shadow p-4 border">
            <div className="flex items-center justify-between mb-3">
              <h2 className="font-medium">Órdenes de Trabajo</h2>
              <button onClick={addOT} className="px-3 py-2 rounded-xl bg-neutral-900 text-white hover:opacity-90">+ Agregar</button>
            </div>
            <div className="overflow-auto">
              <table className="w-full text-sm">
                <thead>
                  <tr className="text-left text-neutral-600">
                    <th className="p-2">Fecha</th>
                    <th className="p-2">Equipo</th>
                    <th className="p-2">Tipo</th>
                    <th className="p-2">Estado</th>
                    <th className="p-2">HH</th>
                    <th className="p-2"></th>
                  </tr>
                </thead>
                <tbody>
                  {state.ots.length === 0 && (
                    <tr>
                      <td className="p-3 text-neutral-500" colSpan={6}>Sin OTs cargadas.</td>
                    </tr>
                  )}
                  {state.ots.map((o) => (
                    <tr key={o.id} className="border-t">
                      <td className="p-2">
                        <input
                          type="date"
                          className="border rounded-lg p-2 w-full"
                          value={o.fecha}
                          onChange={(e) =>
                            setState((s) => ({
                              ...s,
                              ots: s.ots.map((x) => (x.id === o.id ? { ...x, fecha: e.target.value } : x)),
                            }))
                          }
                        />
                      </td>
                      <td className="p-2">
                        <input
                          type="text"
                          className="border rounded-lg p-2 w-full"
                          value={o.equipo}
                          onChange={(e) =>
                            setState((s) => ({
                              ...s,
                              ots: s.ots.map((x) => (x.id === o.id ? { ...x, equipo: e.target.value } : x)),
                            }))
                          }
                        />
                      </td>
                      <td className="p-2">
                        <select
                          className="border rounded-lg p-2 w-full"
                          value={o.tipo}
                          onChange={(e) =>
                            setState((s) => ({
                              ...s,
                              ots: s.ots.map((x) => (x.id === o.id ? { ...x, tipo: e.target.value as WorkOrder["tipo"] } : x)),
                            }))
                          }
                        >
                          <option>Preventivo</option>
                          <option>Correctivo</option>
                          <option>Predictivo</option>
                          <option>Mejora</option>
                        </select>
                      </td>
                      <td className="p-2">
                        <select
                          className="border rounded-lg p-2 w-full"
                          value={o.estado}
                          onChange={(e) =>
                            setState((s) => ({
                              ...s,
                              ots: s.ots.map((x) => (x.id === o.id ? { ...x, estado: e.target.value as WorkOrder["estado"] } : x)),
                            }))
                          }
                        >
                          <option>Planificada</option>
                          <option>En curso</option>
                          <option>Completada</option>
                          <option>Cancelada</option>
                        </select>
                      </td>
                      <td className="p-2">
                        <input
                          type="number"
                          min={0}
                          className="border rounded-lg p-2 w-24"
                          value={o.hh ?? 0}
                          onChange={(e) =>
                            setState((s) => ({
                              ...s,
                              ots: s.ots.map((x) => (x.id === o.id ? { ...x, hh: Number(e.target.value) } : x)),
                            }))
                          }
                        />
                      </td>
                      <td className="p-2 text-right">
                        <button
                          onClick={() => setState((s) => ({ ...s, ots: s.ots.filter((x) => x.id !== o.id) }))}
                          className="px-2 py-1 rounded-lg border hover:bg-neutral-50"
                        >
                          Eliminar
                        </button>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
            <div className="mt-3 text-xs text-neutral-500 flex flex-wrap gap-4">
              <span>OTs: {state.ots.length}</span>
              <span>Planificadas: {otsPlanificadas}</span>
              <span>Completadas: {otsCompletadas}</span>
              <span>Prev: {otsPrev}</span>
              <span>Corr: {otsCorr}</span>
            </div>
          </section>
        </div>

        {/* Notas */}
        <section className="mt-6 bg-white rounded-2xl shadow p-4 border">
          <h2 className="font-medium mb-2">Notas rápidas</h2>
          <AutoGrowTextarea
            placeholder="Escribí ideas, pendientes o decisiones…"
            defaultValue={localStorage.getItem("kpi-notas") || ""}
            onChange={(v) => localStorage.setItem("kpi-notas", v)}
          />
        </section>

        <footer className="py-8 text-center text-xs text-neutral-500">
          MVP localStorage. Luego migramos a Firestore para multiusuario y tiempo real.
        </footer>
      </div>
    </div>
  );
}

function KpiCard({ title, value, hint }: { title: string; value: string; hint?: string }) {
  return (
    <div className="bg-white rounded-2xl shadow p-4 border">
      <div className="text-xs text-neutral-500">{title}</div>
      <div className="text-2xl font-semibold leading-tight">{value}</div>
      {hint && <div className="text-xs text-neutral-500 mt-1">{hint}</div>}
    </div>
  );
}

function AutoGrowTextarea({
  defaultValue = "",
  placeholder,
  onChange,
}: {
  defaultValue?: string;
  placeholder?: string;
  onChange?: (value: string) => void;
}) {
  const ref = useRef<HTMLTextAreaElement | null>(null);
  const [val, setVal] = useState(defaultValue);

  useEffect(() => {
    const el = ref.current;
    if (!el) return;
    el.style.height = "auto";
    el.style.height = el.scrollHeight + "px";
  }, [val]);

  return (
    <textarea
      ref={ref}
      value={val}
      placeholder={placeholder}
      onChange={(e) => {
        setVal(e.target.value);
        onChange?.(e.target.value);
      }}
      className="w-full border rounded-xl p-3 text-sm resize-none focus:outline-none"
      rows={1}
    />
  );
}
